<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VidWise - YouTube Analytics Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --background-color: #f5f5f5;
    --container-bg: #ffffff;
    --text-color: #333;
    --text-light: #555;
    --border-color: #e1e5e9;
    --user-msg-bg: #333333;
    --user-msg-text: #ffffff;
    --ai-msg-bg: #f1f1f1;
    --font-main: 'DM Sans', sans-serif;
    --font-alt: 'Space Grotesk', sans-serif;
    --border-radius-main: 16px;
    --border-radius-msg: 20px;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { height:100%; }
body {
    font-family: var(--font-main);
    background-color: var(--background-color);
    color: var(--text-color);
    min-height: 100vh;
}

/* Removed theme-toggle button styling */

/* Page visibility states with proper display switching */
.chat-page {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    visibility: visible;
    opacity: 1;
}

.chat-page.hidden {
    display: none;
    visibility: hidden;
    opacity: 0;
}

.dashboard-page {
    display: none;
    min-height: 100vh;
    background-color: #f8fafc;
    padding: 0;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    visibility: hidden;
    opacity: 0;
}

.dashboard-page.active {
    display: block;
    visibility: visible;
    opacity: 1;
}

.chat-page .main-container {
    width: 100%;
    max-width: 900px;
    background-color: var(--container-bg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-radius: var(--border-radius-main);
    display: flex;
    flex-direction: column;
    height: 90vh;
    overflow: hidden;
}

.dashboard-page .main-container {
    width: 100%;
    max-width: 100%;
    background-color: transparent;
    box-shadow: none;
    height: 100%;
    overflow-y: auto;
}

.header { padding:40px 20px 20px 20px; text-align:center; flex-shrink:0; }
.header-content { display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
.logo { display:flex; align-items:center; justify-content:center; gap:12px; }
.logo-image { width:150px; height:auto; border:5px solid var(--text-color); border-radius:8px; padding:0; }
.logo h1 { font-size: 1.5rem; font-weight: 700; }

.search-section { display: none; flex: 1; gap: 8px; }
.dashboard-page .search-section { display: flex; }

#backBtn { display: none; padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
.dashboard-page #backBtn { display: block; }

#chat-container { display:flex; flex-grow:1; padding:20px; overflow-y:auto; flex-direction:column; gap:12px; }

@keyframes message-enter-anim { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0);} }
.message-enter { animation: message-enter-anim 0.5s ease-out; }

.message { padding:12px 18px; border-radius:var(--border-radius-msg); max-width:80%; line-height:1.5; word-wrap:break-word; }
.message ul, .message ol { padding-left:25px; margin-top:8px; margin-bottom:8px; }
.message.ai-message { background-color:var(--ai-msg-bg); color:var(--text-color); align-self:flex-start; border-bottom-left-radius:4px; }
.message.user-message { background-color:var(--user-msg-bg); color:var(--user-msg-text); align-self:flex-end; border-bottom-right-radius:4px; }

.typing-indicator { display:flex; align-items:center; padding:15px 0; }
.typing-indicator span { height:8px; width:8px; background-color:#aaa; border-radius:50%; display:inline-block; margin:0 2px; animation: typing-anim 1.4s infinite ease-in-out both; }
.typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing-anim { 0%,80%,100% { transform:scale(0);} 40% { transform:scale(1.0);} }

.search-container { padding:20px; width:100%; flex-shrink:0; border-top: 1px solid var(--border-color); }

.search-box { display:flex; align-items:center; background-color:var(--container-bg); border-radius:25px; padding:16px 16px; border:1px solid var(--border-color); box-shadow:0 2px 8px rgba(0,0,0,0.08); gap:8px; }
.plus-icon { color:#999; margin-right:6px; font-size:1.25rem; font-weight:300; }
.search-input { flex:1; background:none; border:none; color:var(--text-color); font-size:1rem; outline:none; }
.search-input::placeholder { color:#999; }
.send-button { background:none; border:none; color:#999; cursor:pointer; font-size:1.25rem; padding:8px 12px; border-radius:8px; }
.send-button:hover { color:var(--text-color); }

.yt-button { background:#10b981; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight: 600; }
.yt-button:hover { opacity:0.95; }
.yt-button:disabled { opacity:0.5; cursor:not-allowed; }

.youtube-input-container { padding:10px 20px; width:100%; }

.container {
  max-width:1280px;
  margin: 0 auto;
  padding: 0 var(--spacing-lg);
}

.dashboard-page main { width: 100%; max-width: 100%; padding: 20px; }

/* Updated metrics grid to center 5 cards */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
  margin-bottom: 40px;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}

.metric-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  transition: all 0.3s ease;
}

.metric-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border-color: #d1d5db;
}

.metric-title {
  font-size: 12px;
  font-weight: 600;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.metric-value {
  font-size: 36px;
  font-weight: 700;
  color: #1f2937;
  line-height: 1.2;
}

.metric-description {
  font-size: 14px;
  color: #6b7280;
  margin: 0;
  line-height: 1.4;
}

/* Result card with smooth show animation */
#resultCard {
  display: none;
  padding: 20px;
  border-top: 1px solid var(--border-color);
  animation: slideUp 0.3s ease-out;
}

#resultCard.show {
  display: block;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.result-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.result-card img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
}

.result-card h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-color);
}

.result-card p {
  margin: 0;
  font-size: 13px;
  color: #666;
  margin-top: 4px;
  word-break: break-all;
}

.result-card button {
  padding: 10px 20px;
  background: #e9ecef;
  color: #333;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  white-space: nowrap;
  transition: all 0.2s;
}

.result-card button:hover {
  background: #d1d5db;
}

/* Channel Info Card */
.channel-info {
  background-color: var(--container-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-main);
  padding: 24px;
  margin-bottom: 40px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.channel-header {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.channel-header .avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #e5e7eb;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-shrink: 0;
}

.channel-header .avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.channel-details {
  flex: 1;
}

.channel-name {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-color);
  margin-bottom: 4px;
}

.channel-description {
  font-size: 14px;
  color: var(--text-light);
  line-height: 1.5;
  margin-bottom: 12px;
}

.channel-stats {
  display: flex;
  gap: 16px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}

.channel-stats .stat {
  display: flex;
  align-items: center;
  gap: 6px;
}

.channel-stats .stat-icon {
  color: #ef4444;
  font-size: 1.2rem;
}

.status-badge {
  background-color: #10b981;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}

/* Tabs Section */
.tabs-container {
  margin-top: 20px;
}

.tabs-list {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 10px;
}

.tab-trigger {
  background: none;
  border: none;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-light);
  cursor: pointer;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.tab-trigger.active {
  background-color: var(--text-color);
  color: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 20px;
}

.card {
  background: #ffffff;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.card-header {
  margin-bottom: 16px;
}

.card-header h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-color);
  margin-bottom: 4px;
}

.card-header p {
  font-size: 14px;
  color: var(--text-light);
}

.chart-container {
  height: 300px;
  position: relative;
}

/* Demographics */
.demographics {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.demo-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.demo-label {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}

.progress-bar {
  background-color: #e2e8f0;
  border-radius: 100px;
  height: 8px;
  overflow: hidden;
}

.progress-fill {
  background-color: #3b82f6;
  height: 100%;
  border-radius: 100px;
  transition: width 0.3s ease-in-out;
}

.insights {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 16px;
}

.insight {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--text-light);
}

.insight-icon {
  font-size: 1.2rem;
}

/* Videos List */
.videos-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.video-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  transition: background-color 0.2s ease;
}

.video-item:hover {
  background-color: #f1f5f9;
}

.video-thumbnail {
  width: 40px;
  height: 40px;
  background-color: #cbd5e1;
  border-radius: 4px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 700;
  color: #64748b;
  flex-shrink: 0;
}

.video-details {
  flex: 1;
}

.video-details h4 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.video-stats {
  font-size: 12px;
  color: var(--text-light);
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.video-rank {
  font-size: 20px;
  font-weight: 700;
  color: #d1d5db;
  margin-left: auto;
}

/* Geography */
.regions-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.region-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.region-flag {
  font-size: 24px;
}

.region-details {
  flex: 1;
}

.region-label {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 8px;
}

/* Responsive Adjustments */
@media (max-width:768px) {
    body { padding:0; }
    .main-container, .chat-page .main-container { height:100vh; max-height:100vh; border-radius:0; }
    .search-box { padding:12px 14px; }
    .header-content { flex-direction: column; gap:16px; }
    .logo-image { width: 100px; }
    .search-section { width: 100%; }
    .channel-header { flex-direction: column; text-align: center; }
    .channel-stats { justify-content: center; }
    .tabs-list { flex-wrap: wrap; justify-content: center; }
}

@media (max-width: 768px) {
  .metrics-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .metric-card {
    padding: 16px;
  }
  
  .metric-value {
    font-size: 28px;
  }

  .charts-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .metric-value {
    font-size: 24px;
  }

  .search-box { flex-direction: column; }
  .search-input { text-align: center; margin-bottom: 10px; }
  .send-button { width: 100%; margin-top: 10px;}
}
</style>
</head>
<body>

    <!-- Removed theme toggle button -->

    <!-- Chat Page -->
    <div class="chat-page" id="chatPage">
      <div class="main-container">
        <header class="header">
          <div class="logo">
            <img src="assets/WhatsApp Image 2025-09-12 at 17.41.23.jpeg" alt="VidWise" class="logo-image">
            <h1></h1>
          </div>
          <div style="text-align: center; margin-top: 20px; font-size: 24px; font-weight: 600;"></div>
        </header>

        <div id="chat-container"></div>

        <div class="search-container">
          <div class="search-box">
            <span class="plus-icon">+</span>
            <input type="text" id="chatInput" class="search-input" placeholder="Pergunte alguma coisa">
            <button class="send-button" onclick="sendChatMessage()">‚û§</button>
          </div>
        </div>

        <div class="youtube-input-container">
          <div style="display: flex; gap: 8px; align-items: stretch;">
            <input type="text" id="youtubeUrlInput" class="search-input" placeholder="Insira o link do seu canal aqui..." style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
            <button class="yt-button" onclick="goToDashboard()">BUSCAR</button>
          </div>
        </div>

        <!-- Result Card -->
        <div id="resultCard">
          <div class="result-card">
            <img id="resultAvatar" src="https://placeholder.svg?height=64&width=64&query=channel" alt="Canal">
            <div style="flex: 1;">
              <h3 id="resultChannelName">Seu Canal</h3>
              <p id="resultChannelUrl">https://www.youtube.com/channel/...</p>
            </div>
            <button onclick="analyzeFromResult()">Analisar m√©tricas</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Page -->
    <div class="dashboard-page" id="dashboardPage">
      <header class="header">
        <div class="header-content">
          <div class="logo">
            <img src="assets/WhatsApp Image 2025-09-12 at 17.41.23.jpeg" alt="VidWise" class="logo-image" style="width: 48px;">
            <h1 style="font-size: 1.25rem;">VidWise</h1>
          </div>
          <div class="search-section">
            <input type="text" id="searchInput" class="search-input" placeholder="Cole a URL do canal do YouTube..." style="border: 1px solid var(--border-color); padding: 10px; border-radius: 8px;">
            <button id="analyzeBtn" class="yt-button" onclick="triggerAnalyzeUrl()">
              <span class="btn-text">Analisar</span>
            </button>
          </div>
          <button id="backBtn" onclick="backToChat()">‚Üê Voltar</button>
        </div>
      </header>

      <main class="container">
        <!-- Updated channel info card to display dynamic data from API -->
        <div class="card channel-info">
          <div class="channel-header">
            <div class="avatar">
              <img id="channelAvatar" src="https://placeholder.svg?height=80&width=80&query=channel-avatar" alt="Canal" />
            </div>
            <div class="channel-details">
              <h2 class="channel-name" id="dashChannelName">Seu Canal</h2>
              <p class="channel-description" id="dashChannelDesc">Descri√ß√£o n√£o dispon√≠vel</p>
              <div class="channel-stats">
                <div class="stat">
                  <span id="dashStatSubs">0 inscritos</span>
                </div>
                <div class="stat">
                  <span id="dashStatViews">0 visualiza√ß√µes</span>
                </div>
                <div class="stat">
                  <span class="stat-icon">‚ñ∂</span>
                  <span id="dashStatVideos">0 v√≠deos</span>
                </div>
              </div>
            </div>
            <div class="status-badge">Ativo</div>
          </div>
        </div>

        <!-- Updated metrics grid to show only 5 cards -->
        <div class="metrics-grid">
          <div class="card metric-card">
            <div class="metric-title">Quantidade de V√≠deos</div>
            <div class="metric-value" id="dashMetric-videos">0</div>
            <p class="metric-description">Videos publicados</p>
          </div>

          <div class="card metric-card">
            <div class="metric-title">Total de Views</div>
            <div class="metric-value" id="dashMetric-views">0</div>
            <p class="metric-description">Visualiza√ß√µes totais</p>
          </div>

          <div class="card metric-card">
            <div class="metric-title">Inscritos</div>
            <div class="metric-value" id="dashMetric-subs">0</div>
            <p class="metric-description">Subscribers</p>
          </div>

          <div class="card metric-card">
            <div class="metric-title">Tempo M√©dio</div>
            <div class="metric-value" id="dashMetric-avgTime">0</div>
            <p class="metric-description">Tempo m√©dio de assista</p>
          </div>

          <div class="card metric-card">
            <div class="metric-title">Dura√ß√£o M√©dia</div>
            <div class="metric-value" id="dashMetric-avgDuration">0</div>
            <p class="metric-description">Dura√ß√£o m√©dia dos v√≠deos</p>
          </div>
        </div>

        <!-- Tabs Section -->
        <div class="tabs-container">
          <div class="tabs-list">
            <button class="tab-trigger active" data-tab="overview">Vis√£o Geral</button>
            <button class="tab-trigger" data-tab="audience">Audi√™ncia</button>
            <button class="tab-trigger" data-tab="content">Conte√∫do</button>
            <button class="tab-trigger" data-tab="geography">Geografia</button>
          </div>

          <div id="overview" class="tab-content active">
            <div class="charts-grid">
              <div class="card">
                <div class="card-header">
                  <h3>Crescimento Mensal</h3>
                  <p>Visualiza√ß√µes e inscritos nos √∫ltimos 6 meses</p>
                </div>
                <div class="chart-container">
                  <canvas id="growthChart"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3>Hor√°rios de Pico</h3>
                  <p>Engajamento por hor√°rio do dia</p>
                </div>
                <div class="chart-container">
                  <canvas id="peakHoursChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          

              <div class="card">
                <div class="card-header">
                  <h3>Dados Demogr√°ficos</h3>
                  <p>Informa√ß√µes detalhadas da audi√™ncia</p>
                </div>
                <div class="demographics">
                  <div class="demo-item">
                    <div class="demo-label">
                      <span>G√™nero Masculino</span>
                      <span>68%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 68%;"></div>
                    </div>
                  </div>
                  <div class="demo-item">
                    <div class="demo-label">
                      <span>G√™nero Feminino</span>
                      <span>32%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 32%;"></div>
                    </div>
                  </div>
                  <div class="insights">
                    <div class="insight">
                      <span class="insight-icon"></span>
                      <span>P√∫blico principal: Desenvolvedores</span>
                    </div>
                    <div class="insight">
                      <span class="insight-icon"></span>
                      <span>Melhor dia: Ter√ßa-feira</span>
                    </div>
                    <div class="insight">
                      <span class="insight-icon"></span>
                      <span>Melhor hor√°rio: 21:00</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="content" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3>V√≠deos Mais Vistos</h3>
                <p>Top v√≠deos por performance com m√©tricas detalhadas</p>
              </div>
              <div class="videos-list" id="dashVideosList"></div>
            </div>
          </div>

          <div id="geography" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3>Principais Regi√µes</h3>
                <p>Distribui√ß√£o geogr√°fica da audi√™ncia</p>
              </div>
              <div class="regions-list">
                <div class="region-item">
                  <div class="region-flag">üáßüá∑</div>
                  <div class="region-details">
                    <div class="region-label">
                      <span>Brasil</span>
                      <span>68%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 68%;"></div>
                    </div>
                  </div>
                </div>
                <div class="region-item">
                  <div class="region-flag">üáµüáπ</div>
                  <div class="region-details">
                    <div class="region-label">
                      <span>Portugal</span>
                      <span>12%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 12%;"></div>
                    </div>
                  </div>
                </div>
                <div class="region-item">
                  <div class="region-flag">üá∫üá∏</div>
                  <div class="region-details">
                    <div class="region-label">
                      <span>Estados Unidos</span>
                      <span>8%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 8%;"></div>
                    </div>
                  </div>
                </div>
                <div class="region-item">
                  <div class="region-flag">üá¶üá∑</div>
                  <div class="region-details">
                    <div class="region-label">
                      <span>Argentina</span>
                      <span>6%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 6%;"></div>
                    </div>
                  </div>
                </div>
                <div class="region-item">
                  <div class="region-flag">üåç</div>
                  <div class="region-details">
                    <div class="region-label">
                      <span>Outros</span>
                      <span>6%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 6%;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API_YOUTUBE = "http://localhost:3001/youtube";
      const API_PERGUNTA = "http://localhost:3001/pergunta";
      const chatInput = document.getElementById('chatInput');
      const youtubeUrlInput = document.getElementById('youtubeUrlInput');
      const resultCard = document.getElementById('resultCard');
      const chatPage = document.getElementById('chatPage');
      const dashboardPage = document.getElementById('dashboardPage');
      
      let currentChartInstances = {};
      let currentChannelData = {};
      let monthlyGrowthData = null;

      function goToDashboard() {
        const url = youtubeUrlInput.value.trim();
        if (!url) {
          alert('Por favor, cole uma URL do canal YouTube.');
          return;
        }
        
        fetchChannelInfo(url);
      }

      async function fetchChannelInfo(url) {
        try {
          const resp = await fetch(API_YOUTUBE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });
          const data = await resp.json();
          if (!data.ok) throw new Error(data.erro || 'Resposta inv√°lida');

          const ch = data.channel || {};
          currentChannelData = data;

          document.getElementById('resultChannelName').innerText = ch.title || 'Canal';
          document.getElementById('resultChannelUrl').innerText = url;
          if (ch.avatarUrl) {
            document.getElementById('resultAvatar').src = ch.avatarUrl;
          }

          resultCard.classList.add('show');
          resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        } catch (err) {
          alert('Erro ao buscar canal: ' + (err.message || err));
        }
      }

      function analyzeFromResult() {
        if (!currentChannelData || !currentChannelData.channel) {
          alert('Erro: dados do canal n√£o dispon√≠veis.');
          return;
        }

        // Hide chat page, show dashboard
        chatPage.classList.add('hidden');
        dashboardPage.classList.add('active');
        
        populateDashboard(currentChannelData);
        destroyCharts();
        setTimeout(() => initializeCharts(), 100);
      }

      function backToChat() {
        // Hide dashboard, show chat
        dashboardPage.classList.remove('active');
        chatPage.classList.remove('hidden');
        
        // Clear inputs and result card
        youtubeUrlInput.value = '';
        chatInput.value = '';
        resultCard.classList.remove('show');
        
        // Clean up charts
        destroyCharts();
      }

      function populateDashboard(data) {
        const ch = data.channel || {};
        const videos = data.videos || [];

        document.getElementById('dashChannelName').innerText = ch.title || 'Canal';
        document.getElementById('dashChannelDesc').innerText = ch.description || 'Descri√ß√£o n√£o dispon√≠vel';
        document.getElementById('dashStatSubs').innerText = formatNumber(ch.subscribers || 0) + ' inscritos';
        document.getElementById('dashStatViews').innerText = formatNumber(ch.channelTotalViews || 0) + ' visualiza√ß√µes';
        document.getElementById('dashStatVideos').innerText = (ch.channelTotalVideos || videos.length) + ' v√≠deos';

        if (ch.avatarUrl) {
          document.getElementById('channelAvatar').src = ch.avatarUrl;
        }

        const durations = videos.map(v => parseDuration(v.duration));
        const avgDuration = durations.length ? (durations.reduce((a, b) => a + b, 0) / durations.length) : 0;

        document.getElementById('dashMetric-videos').innerText = (ch.channelTotalVideos || videos.length);
        document.getElementById('dashMetric-views').innerText = formatNumber(ch.channelTotalViews || 0);
        document.getElementById('dashMetric-subs').innerText = formatNumber(ch.subscribers || 0);
        document.getElementById('dashMetric-avgTime').innerText = avgDuration.toFixed(1) + ' min';
        document.getElementById('dashMetric-avgDuration').innerText = avgDuration.toFixed(1) + ' min';

        monthlyGrowthData = generateMonthlyGrowthData(videos, ch);

        let videosHtml = '';
        const topVideos = [...videos].sort((a, b) => Number(b.viewCount || 0) - Number(a.viewCount || 0)).slice(0, 10);
        topVideos.forEach((v, idx) => {
          videosHtml += `
            <div class="video-item">
              <div class="video-thumbnail">‚ñ∂</div>
              <div class="video-details">
                <h4>${escapeHtml(v.title)}</h4>
                <div class="video-stats">
                  <span>${formatNumber(Number(v.viewCount || 0))} views</span>
                  <span>${formatNumber(Number(v.likeCount || 0))} likes</span>
                  <span>${formatNumber(Number(v.commentCount || 0))} coment√°rios</span>
                  <span>${v.duration || '-'} dura√ß√£o</span>
                  <span>${v.date || '-'}</span>
                </div>
              </div>
              <div class="video-rank">#${idx + 1}</div>
            </div>
          `;
        });
        document.getElementById('dashVideosList').innerHTML = videosHtml;
      }

      function generateMonthlyGrowthData(videos, channelInfo) {
        const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
        const viewsData = [];
        const subsData = [];

        for (let i = 0; i < months.length; i++) {
          const monthVideos = videos.filter(v => {
            if (!v.date) return false;
            const videoMonth = new Date(v.date).getMonth();
            const currentMonth = new Date().getMonth();
            const monthOffset = (currentMonth - i);
            return videoMonth === ((12 + monthOffset) % 12);
          });

          if (monthVideos.length > 0) {
            const monthViews = monthVideos.reduce((sum, v) => sum + (Number(v.viewCount) || 0), 0);
            viewsData.push(Math.round(monthViews / monthVideos.length));
            subsData.push(Math.round((channelInfo.subscribers || 0) / months.length * (i + 1)));
          } else {
            viewsData.push(0);
            subsData.push(Math.round((channelInfo.subscribers || 0) / months.length * (i + 1)));
          }
        }

        return { labels: months, views: viewsData, subs: subsData };
      }

      function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      function parseDuration(d) {
        if (!d) return 0;
        const p = d.split(':').map(v => parseInt(v, 10));
        if (p.length === 2) return p[0] + p[1] / 60;
        if (p.length === 3) return p[0] * 60 + p[1] + p[2] / 60;
        return 0;
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
      }

      function triggerAnalyzeUrl() {
        const url = document.getElementById('searchInput').value.trim();
        if (!url) {
          alert('Por favor, cole uma URL do canal YouTube.');
          return;
        }
        analyzeYoutube(url);
      }

      async function analyzeYoutube(url) {
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = true;
        const originalText = analyzeBtn.innerText;
        analyzeBtn.innerHTML = '<span class="spinner"></span>';

        try {
          const resp = await fetch(API_YOUTUBE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });
          const data = await resp.json();
          if (!data.ok) throw new Error(data.erro || 'Resposta inv√°lida');

          currentChannelData = data;
          populateDashboard(data);

          destroyCharts();
          setTimeout(() => initializeCharts(), 100);
          document.querySelector('.dashboard-page main').scrollTop = 0;

        } catch (err) {
          alert('Erro ao processar canal: ' + (err.message || err));
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = originalText;
        }
      }

      function destroyCharts() {
        Object.values(currentChartInstances).forEach(chart => {
          if (chart) chart.destroy();
        });
        currentChartInstances = {};
      }

      function getChartColors() {
        return {
          textColor: '#64748b',
          borderColor: '#e2e8f0',
          primaryGradientStart: '#2563eb',
          primaryGradientEnd: '#3b82f6',
          secondaryGradientStart: '#64748b',
          secondaryGradientEnd: '#94a3b8',
          backgroundAlpha: 'rgba(37, 99, 235, 0.1)',
        };
      }

      function createGradient(ctx, colorStart, colorEnd) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, colorStart);
        gradient.addColorStop(1, colorEnd);
        return gradient;
      }

      function initializeCharts() {
        const colors = getChartColors();
        Chart.defaults.color = colors.textColor;
        Chart.defaults.borderColor = colors.borderColor;

        const growthData = monthlyGrowthData || {
          labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
          views: [45000, 52000, 48000, 61000, 55000, 67000],
          subs: [1200, 1800, 1500, 2200, 1900, 2800]
        };

        const ctxGrowth = document.getElementById('growthChart')?.getContext('2d');
        if (ctxGrowth) {
          currentChartInstances.growth = new Chart(ctxGrowth, {
            type: 'bar',
            data: {
              labels: growthData.labels,
              datasets: [{
                label: 'Visualiza√ß√µes',
                data: growthData.views,
                backgroundColor: createGradient(ctxGrowth, colors.primaryGradientStart, colors.primaryGradientEnd),
                borderRadius: 8,
                borderWidth: 0,
              }, {
                label: 'Inscritos',
                data: growthData.subs,
                backgroundColor: createGradient(ctxGrowth, colors.secondaryGradientStart, colors.secondaryGradientEnd),
                borderRadius: 8,
                borderWidth: 0,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top', labels: { padding: 15, font: { size: 13, weight: '600' } } },
              },
              scales: {
                y: { beginAtZero: true, grid: { color: colors.borderColor } },
                x: { grid: { display: false } },
              },
            }
          });
        }

        const ctxPeakHours = document.getElementById('peakHoursChart')?.getContext('2d');
        if (ctxPeakHours) {
          currentChartInstances.peakHours = new Chart(ctxPeakHours, {
            type: 'line',
            data: {
              labels: ['06:00', '09:00', '12:00', '15:00', '18:00', '21:00', '00:00'],
              datasets: [{
                label: 'Engajamento (%)',
                data: [15, 35, 60, 45, 85, 95, 25],
                borderColor: colors.primaryGradientStart,
                backgroundColor: colors.backgroundAlpha,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colors.primaryGradientStart,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'top', labels: { padding: 15, font: { size: 13, weight: '600' } } } },
              scales: {
                y: { beginAtZero: true, max: 100, grid: { color: colors.borderColor } },
                x: { grid: { color: colors.borderColor, lineWidth: 0.5 } },
              },
            }
          });
        }

        const ctxAge = document.getElementById('ageChart')?.getContext('2d');
        if (ctxAge) {
          const ageColors = ['#2563eb', '#8b5cf6', '#3b82f6', '#a78bfa'];
          
          currentChartInstances.age = new Chart(ctxAge, {
            type: 'doughnut',
            data: {
              labels: ['18-24', '25-34', '35-44', '45+'],
              datasets: [{
                data: [35, 45, 15, 5],
                backgroundColor: ageColors,
                borderWidth: 0,
                hoverOffset: 8,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 13, weight: '600' } } } },
            }
          });
        }
      }

      function sendChatMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        const container = document.getElementById('chat-container');
        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message message-enter';
        userMsg.innerText = message;
        container.appendChild(userMsg);
        
        chatInput.value = '';
        container.scrollTop = container.scrollHeight;
        
        setTimeout(async () => {
          const typingDiv = document.createElement('div');
          typingDiv.className = 'typing-indicator';
          typingDiv.innerHTML = '<span></span><span></span><span></span>';
          container.appendChild(typingDiv);
          container.scrollTop = container.scrollHeight;
          
          try {
            const response = await fetch(API_PERGUNTA, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                  pergunta: message,
                  dados: {}
               })
            });

            typingDiv.remove();
            
            const data = await response.json();
            const aiContent = data.ok
                ? (data.resposta?.answer || JSON.stringify(data.resposta))
               : `‚ùå Erro: ${data.erro || 'Resposta inv√°lida'}`;

            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai-message message-enter';
            aiMsg.innerText = aiContent;

            container.appendChild(aiMsg);
            container.scrollTop = container.scrollHeight;

          } catch (err) {
            typingDiv.remove();
            
            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai-message message-enter';
            aiMsg.innerText = 'Desculpe, houve um erro ao conectar com a IA. Verifique se o servidor est√° rodando.';
            container.appendChild(aiMsg);
            container.scrollTop = container.scrollHeight;
          }
        }, 300);
      }

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });

      document.querySelectorAll('.tab-trigger').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          document.querySelectorAll('.tab-trigger').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tabName).classList.add('active');
        });
      });
    </script>
</body>
</html>
